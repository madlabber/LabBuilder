---
- name: set vmw vars
  set_fact:
    host_type: "vmw"
    checksum_type: "block"
  when:
    - vcenter_address ~ esxi_address != ''

- name: Map ESXi login variables
  set_fact:
    vcenter_address: "{{ esxi_address }}"
    vcenter_username: "{{ esxi_username }}"
    vcenter_password: "{{ esxi_password }}"
    vcenter_datacenter: "ha-datacenter"
  delegate_to: localhost
  when: 
    - vcenter_address ~ esxi_address != ''
    - vcenter_address ~ esxi_address == esxi_address

- name: set pve vars
  set_fact:
    host_type: "pve"
    checksum_type: "zoned"
    pve_datastore: "{{ datastore_substitutions[vm_datastore]|default(vm_datastore) }}"
    pve_data_network: "{{ network_substitutions[data_network]|default(data_network) }}"
    pve_cluster_network: "{{ network_substitutions[cluster_network]|default(cluster_network) }}"
  when:
    - pve_address != ''    

- name: Add PVE Host to Dynamic Inventory
  add_host:
    hostname: temp_host
    group: "temp_hosts"
    ansible_host: '{{ pve_address }}'
    ansible_user: '{{ pve_username }}'
    ansible_password: '{{ pve_password }}'
    ansible_ssh_common_args: '-o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no'
  when: 
    - host_type == 'pve'

# if cluster network is not set, connect those ports to the data network
- name: select cluster network
  set_fact:
    cluster_network: "{{ data_network }}"
  when: cluster_network == ""

# Generate a random nvram_sysid 
- name: generate sysid
  set_fact:
    nvram_sysid: "4082{{ 9 | random(start=0) }}{{ 9 | random(start=0) }}{{ 9 | random(start=0) }}{{ 9 | random(start=0) }}07" #the two current options are 408236507, or 4034389062
  when: nvram_sysid == ""

- name: set partner identifiers
  set_fact:
    node1_name:   "{{ vm_name }}"
    node2_name:   "{{ partner_name }}"
    node1_sysid:  "{{ nvram_sysid }}"
    node2_sysid:  "{{ nvram_sysid|int + 1 }}"
    node1_serial: "{{ sys_serial_number }}"
    node2_serial: "{{ partner_serial|default('4034389-06-2',true) }}"
    node1_icmac:   "{{ node1_icmac | default('02:0C:01' | random_mac ) }}"
    node2_icmac:   "{{ node2_icmac | default('02:0C:02' | random_mac ) }}"
    node2_mgmt_ip: "{{ node2_mgmt_ip | default(partner_ip|default('')) }}"
    node_setup_delay: "{{ node_setup_delay | default(120) }}"
    add_nodes_by_serial: "{{ add_nodes_by_serial | default( partner_serial|default('4034389-06-2',true),true ) }}"
  when: 
    - partner_name|default("") != ""

- name: enforce minimum nics for HA
  set_fact:
    vm_num_nics: 5
  when: 
    - vm_num_nics|int <= 4
    - partner_name|default("") != ""

- name: enforce minimum nics for PVE HA
  set_fact:
    vm_num_nics: 6
  when: 
    - vm_num_nics|int <= 5
    - partner_name|default("") != ""
    - host_type == "pve"

# - set_fact:
#     ethernet_ports:
#       e0a: "VM Network"
#       e0b: "VM Network"
#       e0c: "Cluster Network"
#       e0d: "Cluster Network"

# - set_fact:
#     ethernet_ports:
#       e0e: "VM Network"

# - debug:
#     msg:
#       - "count: {{ ethernet_ports| length }}"
#       - "e0a: {{ network_substitutions[ethernet_ports.e0a|default(cluster_network)] }}"
#       - "e0b: {{ network_substitutions[ethernet_ports.e0b|default(cluster_network)] }}"
#       - "e0c: {{ network_substitutions[ethernet_ports.e0c|default(data_network)] }}"  
#       - "e0d: {{ network_substitutions[ethernet_ports.e0d|default(data_network)] }}" 
#       - "e0e: {{ network_substitutions[ethernet_ports.e0e|default('')]|default('') }}"          
#       - "e0f: {{ network_substitutions[ethernet_ports.e0f|default('')]|default('') }}" 
#       - "e0g: {{ network_substitutions[ethernet_ports.e0g|default('')]|default('') }}" 
#       - "e0h: {{ network_substitutions[ethernet_ports.e0h|default('')]|default('') }}"   
          
# - debug:
#     msg:
#       - "break: {{break}}"