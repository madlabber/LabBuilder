---
- name: parse variables
  include_tasks: parse_vars.yml

- name: remove vm if state is absent or forced
  include_tasks: "{{host_type}}/absent.yml"

- name: parse disks
  include_tasks: parse_disks.yml

- name: parse networks
  include_tasks: "{{host_type}}/parse_networks.yml"

- name: locate ovf file - {{ovf_file}}
  include_tasks: locate_ovf_file.yml

- name: extract OVA
  include_tasks: extract_ova.yml

- name: install update
  include_tasks: install_update.yml

- name: Set bootargs
  include_tasks: set_bootargs.yml
  when: node_name | default('') != ''
  loop_control:
    loop_var: node_name
  loop:
    - "{{vm_name}}"
    - "{{partner_name}}"

- name: Create setup.ngsh
  include_tasks: create_setup_ngsh.yml

- name: update OVA
  include_tasks: update_ova.yml

- name: Build VM 
  include_tasks: "{{host_type}}/build_vm.yml"
  when: loop_vm_name | default('') != ''
  loop_control:
    loop_var: loop_vm_name
  loop:
    - "{{vm_name}}"
    - "{{partner_name}}"

- name: Add disks
  include_tasks: "{{host_type}}/add_disks.yml"
  when: 
    - disk_model == "vscsi"
    - partner_name == ""

- name: Add shared disks
  include_tasks: "{{host_type}}/add_shared_disks.yml"
  when: 
    - disk_model == "vscsi"
    - partner_name != ""
  
- name: Start VM 
  include_tasks: "{{host_type}}/start_vm.yml"

- name: cleanup
  include_tasks: cleanup.yml